{% extends 'tickets/base.html' %}

{% block title %}Kullanıcı Yönetimi - Yardım Masası{% endblock %}

{% block page_title %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/"><i class="fas fa-home"></i> Ana Sayfa</a></li>
                <li class="breadcrumb-item"><a href="/accounts/admin-panel/">Admin Panel</a></li>
                <li class="breadcrumb-item active">Kullanıcı Yönetimi</li>
            </ol>
        </nav>
        <h1 class="page-title">
            <i class="bi bi-person-lines-fill text-primary me-3"></i>Kullanıcı Yönetimi
            <span class="badge bg-primary ms-2">Admin</span>
        </h1>
        <p class="page-subtitle">Sistem kullanıcılarını yönetin</p>
    </div>
    <div>
        <a href="/accounts/admin/users/create/" class="btn btn-primary">
            <i class="bi bi-person-plus-fill me-2"></i>Yeni Kullanıcı
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- Stats Cards -->
<div class="row g-4 mb-4">
    <div class="col-lg-3 col-md-6">
        <div class="stat-card bg-primary">
            <div class="stat-card-body">
                <div class="stat-icon"><i class="bi bi-people-fill"></i></div>
                <div class="stat-content">
                    <h3 class="stat-number">{{ users|length }}</h3>
                    <p class="stat-label">Toplam Kullanıcı</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
        <div class="stat-card bg-success">
            <div class="stat-card-body">
                <div class="stat-icon"><i class="bi bi-person-check-fill"></i></div>
                <div class="stat-content">
                    <h3 class="stat-number">{{ users|length }}</h3>
                    <p class="stat-label">Aktif Kullanıcı</p>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6">
        <div class="stat-card bg-warning">
            <div class="stat-card-body">
                <div class="stat-icon"><i class="bi bi-shield-fill-check"></i></div>
                <div class="stat-content">
                    <h3 class="stat-number">1</h3>
                    <p class="stat-label">Admin Kullanıcı</p>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6">
        <div class="stat-card bg-info">
            <div class="stat-card-body">
                <div class="stat-icon"><i class="bi bi-headset"></i></div>
                <div class="stat-content">
                    <h3 class="stat-number">0</h3>
                    <p class="stat-label">Support Kullanıcı</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Users Table -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-table me-2"></i>Kullanıcı Listesi</h5>
        <div class="input-group" style="max-width: 300px;">
            <input type="text" id="searchInput" class="form-control" placeholder="Kullanıcı ara...">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
        </div>
    </div>
    <div class="card-body">
        {% if users %}
        <div class="table-responsive">
            <table class="table table-hover align-middle" id="usersTable">
                <thead class="table-light">
                    <tr>
                        <th>Kullanıcı</th>
                        <th>E-posta</th>
                        <th>Rol</th>
                        <th>Gruplar</th>
                        <th>Durum</th>
                        <th>Kayıt Tarihi</th>
                        <th>İşlemler</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr class="user-row">
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    {% if user.is_superuser %}
                                        <i class="bi bi-crown-fill text-warning"></i>
                                    {% elif user.role == 'admin' %}
                                        <i class="bi bi-shield-fill-check text-danger"></i>
                                    {% elif user.role == 'support' %}
                                        <i class="bi bi-headset text-success"></i>
                                    {% else %}
                                        <i class="bi bi-person-fill text-primary"></i>
                                    {% endif %}
                                </div>
                                <div>
                                    <strong>{{ user.username }}</strong>
                                    {% if user.first_name or user.last_name %}
                                        <br><small class="text-muted">{{ user.first_name }} {{ user.last_name }}</small>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td>
                            {% if user.email %}
                                <a href="mailto:{{ user.email }}">{{ user.email }}</a>
                            {% else %}
                                <span class="text-muted">E-posta yok</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if user.is_superuser %}
                                <span class="badge bg-warning">Super Admin</span>
                            {% elif user.role == 'admin' %}
                                <span class="badge bg-danger">Admin</span>
                            {% elif user.role == 'support' %}
                                <span class="badge bg-success">Support</span>
                            {% else %}
                                <span class="badge bg-primary">Customer</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if user.groups.all %}
                                <div class="d-flex flex-wrap gap-1">
                                    {% for group in user.groups.all %}
                                        <span class="badge bg-info text-dark">
                                            <i class="bi bi-people-fill me-1"></i>{{ group.name }}
                                        </span>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <span class="text-muted small">
                                    <i class="bi bi-dash-circle-fill me-1"></i>Grup yok
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            {% if user.is_active %}
                                <span class="badge bg-success">Aktif</span>
                            {% else %}
                                <span class="badge bg-secondary">Pasif</span>
                            {% endif %}
                        </td>
                        <td>{{ user.date_joined|date:"d.m.Y H:i" }}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <a href="/accounts/admin/users/{{ user.id }}/edit/" class="btn btn-outline-primary" title="Düzenle">
                                    <i class="bi bi-pencil-square"></i>
                                </a>
                                <a href="/accounts/admin/users/{{ user.id }}/assign-groups/" class="btn btn-outline-info" title="Grup Ata">
                                    <i class="bi bi-people-fill"></i>
                                </a>
                                {% if not user.is_superuser %}
                                <button class="btn btn-outline-danger" onclick="deleteUser({{ user.id }}, '{{ user.username }}')" title="Sil">
                                    <i class="bi bi-trash3-fill"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="bi bi-people fs-1 text-muted mb-3"></i>
            <h5 class="text-muted">Henüz kullanıcı bulunmamaktadır</h5>
            <a href="/accounts/admin/users/create/" class="btn btn-primary mt-2">
                <i class="bi bi-person-plus-fill me-2"></i>İlk Kullanıcıyı Oluşturun
            </a>
        </div>
        {% endif %}
    </div>
</div>

<script>
// Simple search functionality
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const tableRows = document.querySelectorAll('.user-row');
    
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            
            tableRows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    }
});

// Delete user function
function deleteUser(userId, username) {
    if (confirm(`"${username}" kullanıcısını silmek istediğinizden emin misiniz?`)) {
        alert('Silme işlemi henüz implementa edilmedi.');
    }
}
</script>

<!-- CSRF Token for AJAX -->
<form style="display:none;">{% csrf_token %}</form>
{% endblock %}