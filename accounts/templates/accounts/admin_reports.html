{% extends 'tickets/base.html' %}

{% block title %}Raporlar - HelpDesk{% endblock %}

{% block sidebar_nav %}
<div class="nav-section">
    <div class="nav-section-title">Yönetim Paneli</div>
    <div class="nav-item"><a href="/accounts/admin-panel/" class="nav-link"><i class="fas fa-tachometer-alt"></i><span>Ana Panel</span></a></div>
    <div class="nav-item"><a href="/accounts/admin/users/" class="nav-link"><i class="fas fa-users"></i><span>Kullanıcılar</span></a></div>
    <div class="nav-item"><a href="/accounts/admin/groups/" class="nav-link"><i class="fas fa-users-cog"></i><span>Gruplar</span></a></div>
    <div class="nav-item"><a href="/accounts/admin/settings/" class="nav-link"><i class="fas fa-cog"></i><span>Sistem Ayarları</span></a></div>
    <div class="nav-item"><a href="/accounts/admin/reports/" class="nav-link active"><i class="fas fa-chart-bar"></i><span>Raporlar</span></a></div>
    <div class="nav-item"><a href="/accounts/debug-tokens/" class="nav-link"><i class="fas fa-bug"></i><span>Debug</span></a></div>
</div>

<div class="nav-section">
    <div class="nav-section-title">Ana Menü</div>
    <div class="nav-item"><a href="/" class="nav-link"><i class="fas fa-home"></i><span>Ana Sayfa</span></a></div>
    <div class="nav-item"><a href="/tickets/" class="nav-link"><i class="fas fa-ticket-alt"></i><span>Talepler</span></a></div>
</div>

<div class="nav-section">
    <div class="nav-section-title">Kişisel</div>
    <div class="nav-item"><a href="/accounts/profile/" class="nav-link"><i class="fas fa-user"></i><span>Profil</span></a></div>
</div>
{% endblock %}

{% block breadcrumb %}
<ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/"><i class="fas fa-home"></i></a></li>
    <li class="breadcrumb-item"><a href="/accounts/admin-panel/">Admin Panel</a></li>
    <li class="breadcrumb-item active">Raporlar</li>
</ol>
{% endblock %}

{% block page_title %}
<div class="d-flex justify-content-between align-items-center">
    <div>
        <h1 class="page-title"><i class="fas fa-chart-bar text-info me-3"></i>Sistem Raporları<span class="badge bg-info ms-2">Admin</span></h1>
        <p class="page-subtitle">Analiz, istatistik ve raporlar</p>
    </div>
    <div>
        <a href="/accounts/admin/reports/export/" class="btn btn-info"><i class="fas fa-download me-2"></i>Rapor İndir</a>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid">

  <!-- Rapor Kartları -->
  <div class="row g-4 mb-4">
    <div class="col-lg-3 col-md-6">
      <div class="card text-white bg-primary">
        <div class="card-body d-flex align-items-center">
          <div class="flex-grow-1">
            <h6 class="card-title mb-0">Toplam Talep</h6>
            <h3 class="mb-0">{{ stats.total_tickets }}</h3>
          </div>
          <div class="ms-3"><i class="bi bi-ticket-perforated fs-2"></i></div>
        </div>
      </div>
    </div>

    <div class="col-lg-3 col-md-6">
      <div class="card text-white bg-info">
        <div class="card-body d-flex align-items-center">
          <div class="flex-grow-1">
            <h6 class="card-title mb-0">Toplam Kullanıcı</h6>
            <h3 class="mb-0">{{ stats.total_users }}</h3>
          </div>
          <div class="ms-3"><i class="bi bi-people fs-2"></i></div>
        </div>
      </div>
    </div>

    <div class="col-lg-3 col-md-6">
      <div class="card text-white bg-success">
        <div class="card-body d-flex align-items-center">
          <div class="flex-grow-1">
            <h6 class="card-title mb-0">Çözülen Talepler</h6>
            <h3 class="mb-0">{{ stats.resolved_tickets }}</h3>
          </div>
          <div class="ms-3"><i class="bi bi-check-circle fs-2"></i></div>
        </div>
      </div>
    </div>

    <div class="col-lg-3 col-md-6">
      <div class="card text-white bg-warning">
        <div class="card-body d-flex align-items-center">
          <div class="flex-grow-1">
            <h6 class="card-title mb-0">Bekleyen Talepler</h6>
            <h3 class="mb-0">{{ stats.pending_tickets }}</h3>
          </div>
          <div class="ms-3"><i class="bi bi-hourglass-split fs-2"></i></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Grafikler -->
  <div class="row">
    <div class="col-lg-6 mb-4">
      <div class="card">
        <div class="card-header"><h5 class="card-title mb-0"><i class="bi bi-pie-chart me-2"></i>Talep Durumu Dağılımı</h5></div>
        <div class="card-body">
          <canvas id="ticketStatusChart" height="200"></canvas>
        </div>
      </div>
    </div>

    <div class="col-lg-6 mb-4">
      <div class="card">
        <div class="card-header"><h5 class="card-title mb-0"><i class="bi bi-graph-up me-2"></i>Aylık Aktivite</h5></div>
        <div class="card-body">
          <canvas id="monthlyActivityChart" height="200"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Son Aktiviteler -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header"><h5 class="card-title mb-0"><i class="bi bi-clock-history me-2"></i>Son Aktiviteler</h5></div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr><th>Tarih</th><th>Kullanıcı</th><th>Aktivite</th><th>Durum</th></tr>
              </thead>
              <tbody>
                {% for activity in recent_activities %}
                <tr>
                  <td>{{ activity.created_at|date:"d.m.Y H:i" }}</td>
                  <td>{{ activity.user.username }}</td>
                  <td>Yeni talep oluşturdu: "{{ activity.title|truncatechars:50 }}"</td>
                  <td>
                    {% if activity.status == 'open' %}
                      <span class="badge bg-warning">Açık</span>
                    {% elif activity.status == 'in_progress' %}
                      <span class="badge bg-info">Devam Ediyor</span>
                    {% elif activity.status == 'closed' %}
                      <span class="badge bg-success">Kapalı</span>
                    {% else %}
                      <span class="badge bg-secondary">{{ activity.get_status_display }}</span>
                    {% endif %}
                  </td>
                </tr>
                {% empty %}
                <tr><td colspan="4" class="text-center text-muted py-4"><i class="bi bi-inbox fs-1"></i><p class="mt-2">Henüz aktivite bulunmuyor.</p></td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js Script -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const ticketStatusCtx = document.getElementById('ticketStatusChart').getContext('2d');
const monthlyActivityCtx = document.getElementById('monthlyActivityChart').getContext('2d');

// Placeholder Chart.js config (verileri backend'den doldur)
const ticketStatusChart = new Chart(ticketStatusCtx, {
    type: 'pie',
    data: { labels: [], datasets: [{ data: [], backgroundColor: [] }] },
    options: { responsive: true }
});
const monthlyActivityChart = new Chart(monthlyActivityCtx, {
    type: 'bar',
    data: { labels: [], datasets: [{ label: 'Talepler', data: [], backgroundColor: 'rgba(54, 162, 235, 0.7)' }] },
    options: { responsive: true, scales: { y: { beginAtZero: true } } }
});

// Rapor indirme ve toast fonksiyonları
function exportReport(type, format) {
    showToast('info', 'Rapor hazırlanıyor...');
    const url = `/accounts/admin/reports/export/?type=${type}&format=${format}`;
    const link = document.createElement('a'); link.href = url; link.style.display='none'; document.body.appendChild(link); link.click(); document.body.removeChild(link);
    setTimeout(()=>showToast('success','Rapor başarıyla indirildi!'),1000);
}
function generatePDFReport() { showToast('warning','PDF rapor özelliği yakında eklenecek!'); }
function showToast(type,message){
    const toastHtml = `<div class="toast align-items-center text-white bg-${type==='info'?'primary':type==='success'?'success':'warning'} border-0" role="alert"><div class="d-flex"><div class="toast-body"><i class="bi bi-${type==='info'?'info-circle':type==='success'?'check-circle':'exclamation-triangle'} me-2"></i>${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div></div>`;
    let container = document.getElementById('toast-container'); if(!container){ container=document.createElement('div'); container.id='toast-container'; container.className='toast-container position-fixed top-0 end-0 p-3'; container.style.zIndex='1055'; document.body.appendChild(container);}
    container.insertAdjacentHTML('beforeend',toastHtml);
    const t=document.querySelector('#toast-container .toast:last-child'); const b=new bootstrap.Toast(t,{delay:3000}); b.show(); t.addEventListener('hidden.bs.toast',()=>t.remove()); return b;
}
</script>
{% endblock %}