{% extends 'tickets/base.html' %}

{% block title %}{{ page_title }}{% endblock %}
{% block page_title %}{{ page_title }}{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb" class="mb-4">
  <ol class="breadcrumb">
    <li class="breadcrumb-item">
      <a href="{% url 'home' %}" style="color: var(--accent-color);">
        <i class="bi bi-house-door me-1"></i>Ana Sayfa
      </a>
    </li>
    <li class="breadcrumb-item">
      <a href="/accounts/admin-panel/" style="color: var(--accent-color);">
        <i class="bi bi-shield-check me-1"></i>Admin Panel
      </a>
    </li>
    <li class="breadcrumb-item active" aria-current="page">Raporlar</li>
  </ol>
</nav>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- Page Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h1 class="h3 mb-0">
            <i class="bi bi-graph-up text-info me-2"></i>Raporlar ve Analitik
          </h1>
          <p class="text-muted mb-0">Sistem istatistikleri ve performans raporları</p>
        </div>
        <div>
          <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
            <i class="bi bi-download me-2"></i>Rapor İndir
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" onclick="exportReport('tickets', 'csv')">
              <i class="bi bi-file-earmark-spreadsheet me-2"></i>Talep Raporu (CSV)
            </a></li>
            <li><a class="dropdown-item" href="#" onclick="exportReport('users', 'csv')">
              <i class="bi bi-people me-2"></i>Kullanıcı Raporu (CSV)
            </a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="#" onclick="generatePDFReport()">
              <i class="bi bi-file-earmark-pdf me-2"></i>PDF Özet Raporu
            </a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Report Cards -->
  <div class="row g-4 mb-4">
    <!-- Toplam Talepler -->
    <div class="col-lg-3 col-md-6">
      <div class="card text-white" style="background-color: var(--primary-color);">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="flex-grow-1">
              <h6 class="card-title mb-0">Toplam Talep</h6>
              <h3 class="mb-0">{{ stats.total_tickets }}</h3>
            </div>
            <div class="ms-3">
              <i class="bi bi-ticket-perforated fs-2"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Toplam Kullanıcılar -->
    <div class="col-lg-3 col-md-6">
      <div class="card text-white" style="background-color: var(--info-color);">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="flex-grow-1">
              <h6 class="card-title mb-0">Toplam Kullanıcı</h6>
              <h3 class="mb-0">{{ stats.total_users }}</h3>
            </div>
            <div class="ms-3">
              <i class="bi bi-people fs-2"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Toplam Talepler -->
    <div class="col-lg-3 col-md-6">
      <div class="card text-white" style="background-color: var(--success-color);">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="flex-grow-1">
              <h6 class="card-title mb-0">Toplam Talep</h6>
              <h3 class="mb-0">1,247</h3>
            </div>
            <div class="ms-3">
              <i class="bi bi-ticket-perforated fs-2"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Çözülen Talepler -->
    <div class="col-lg-3 col-md-6">
      <div class="card text-white" style="background-color: var(--info-color);">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="flex-grow-1">
              <h6 class="card-title mb-0">Çözülen</h6>
              <h3 class="mb-0">1,089</h3>
            </div>
            <div class="ms-3">
              <i class="bi bi-check-circle fs-2"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bekleyen Talepler -->
    <div class="col-lg-3 col-md-6">
      <div class="card text-white" style="background-color: var(--warning-color);">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="flex-grow-1">
              <h6 class="card-title mb-0">Bekleyen</h6>
              <h3 class="mb-0">158</h3>
            </div>
            <div class="ms-3">
              <i class="bi bi-hourglass-split fs-2"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts and Reports -->
  <div class="row">
    <!-- Ticket Status Chart -->
    <div class="col-lg-6 mb-4">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="bi bi-pie-chart me-2"></i>Talep Durumu Dağılımı
          </h5>
        </div>
        <div class="card-body">
          <div class="text-center py-5">
            <i class="bi bi-bar-chart-fill fs-1 text-muted"></i>
            <p class="text-muted mt-3">Grafik verisi yükleniyor...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Monthly Activity -->
    <div class="col-lg-6 mb-4">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="bi bi-graph-up me-2"></i>Aylık Aktivite
          </h5>
        </div>
        <div class="card-body">
          <div class="text-center py-5">
            <i class="bi bi-graph-up-arrow fs-1 text-muted"></i>
            <p class="text-muted mt-3">Grafik verisi yükleniyor...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Activity -->
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="bi bi-clock-history me-2"></i>Son Aktiviteler
          </h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Tarih</th>
                  <th>Kullanıcı</th>
                  <th>Aktivite</th>
                  <th>Durum</th>
                </tr>
              </thead>
              <tbody>
                {% for activity in recent_activities %}
                <tr>
                  <td>{{ activity.created_at|date:"d.m.Y H:i" }}</td>
                  <td>{{ activity.user.username }}</td>
                  <td>Yeni talep oluşturdu: "{{ activity.title|truncatechars:50 }}"</td>
                  <td>
                    {% if activity.status == 'open' %}
                      <span class="badge bg-warning">Açık</span>
                    {% elif activity.status == 'in_progress' %}
                      <span class="badge bg-info">Devam Ediyor</span>
                    {% elif activity.status == 'closed' %}
                      <span class="badge bg-success">Kapalı</span>
                    {% else %}
                      <span class="badge bg-secondary">{{ activity.get_status_display }}</span>
                    {% endif %}
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="4" class="text-center text-muted py-4">
                    <i class="bi bi-inbox fs-1"></i>
                    <p class="mt-2">Henüz aktivite bulunmuyor.</p>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function exportReport(type, format) {
    // Loading state göster
    const toast = showToast('info', 'Rapor hazırlanıyor, lütfen bekleyin...');
    
    // Export URL'ini oluştur
    const url = `/accounts/admin/reports/export/?type=${type}&format=${format}`;
    
    // Download link oluştur
    const link = document.createElement('a');
    link.href = url;
    link.download = '';
    link.style.display = 'none';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // Başarı mesajı
    setTimeout(() => {
        showToast('success', 'Rapor başarıyla indirildi!');
    }, 1000);
}

function generatePDFReport() {
    showToast('warning', 'PDF rapor özelliği yakında eklenecek!');
}

function showToast(type, message) {
    // Bootstrap toast gösterme fonksiyonu
    const toastHtml = `
        <div class="toast align-items-center text-white bg-${type === 'info' ? 'primary' : type === 'success' ? 'success' : 'warning'} border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="bi bi-${type === 'info' ? 'info-circle' : type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    
    // Toast container oluştur veya mevcut olanı kullan
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        toastContainer.style.zIndex = '1055';
        document.body.appendChild(toastContainer);
    }
    
    // Toast'u ekle
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    
    // Toast'u göster
    const toastElement = toastContainer.lastElementChild;
    const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
    toast.show();
    
    // Toast kapandığında elementi kaldır
    toastElement.addEventListener('hidden.bs.toast', () => {
        toastElement.remove();
    });
    
    return toast;
}
</script>
{% endblock %}