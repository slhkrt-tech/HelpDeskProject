{% extends 'tickets/base.html' %}

{% block title %}{{ panel_title }} - HelpDesk{% endblock %}

{% block breadcrumb %}
<ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/"><i class="fas fa-home"></i></a></li>
    <li class="breadcrumb-item"><a href="/accounts/admin-panel/">Admin Panel</a></li>
    <li class="breadcrumb-item active">Grup Yönetimi</li>
</ol>
{% endblock %}

{% block page_title %}
<div class="d-flex justify-content-between align-items-center">
    <div>
        <h1 class="page-title"><i class="fas fa-users-cog text-success me-3"></i>Grup Yönetimi <span class="badge bg-success ms-2">Admin</span></h1>
        <p class="page-subtitle">Kullanıcı gruplarını yönetin</p>
    </div>
    <div>
        <a href="/accounts/admin/groups/create/" class="btn btn-success"><i class="fas fa-plus me-2"></i>Yeni Grup</a>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- Stats Cards -->
  <div class="row g-4 mb-4">
    <div class="col-lg-4 col-md-6">
      <div class="card border-0 shadow-sm">
        <div class="card-body d-flex align-items-center">
          <div class="flex-grow-1">
            <h6 class="text-muted mb-0">Toplam Grup</h6>
            <h4 class="text-primary mb-0">{{ groups|length }}</h4>
          </div>
          <div class="ms-3"><i class="bi bi-collection fs-2 text-primary"></i></div>
        </div>
      </div>
    </div>
    
    <div class="col-lg-4 col-md-6">
      <div class="card border-0 shadow-sm">
        <div class="card-body d-flex align-items-center">
          <div class="flex-grow-1">
            <h6 class="text-muted mb-0">Gruplu Kullanıcı</h6>
            <h4 class="text-success mb-0">{{ total_users_in_groups }}</h4>
          </div>
          <div class="ms-3"><i class="bi bi-people-fill fs-2 text-success"></i></div>
        </div>
      </div>
    </div>
    
    <div class="col-lg-4 col-md-6">
      <div class="card border-0 shadow-sm">
        <div class="card-body d-flex align-items-center">
          <div class="flex-grow-1">
            <h6 class="text-muted mb-0">Ortalama Grup Boyutu</h6>
            <h4 class="text-info mb-0">{{ average_group_size }}</h4>
          </div>
          <div class="ms-3"><i class="bi bi-bar-chart fs-2 text-info"></i></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Groups Table -->
  <div class="row">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-transparent border-0 py-3 d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Grup Listesi</h5>
          <div class="input-group" style="max-width: 300px;">
            <input type="text" id="searchInput" class="form-control" placeholder="Grup ara...">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
          </div>
        </div>
        <div class="card-body">
          {% if groups %}
            <div class="table-responsive">
              <table class="table table-hover align-middle" id="groupsTable">
                <thead class="table-light">
                  <tr>
                    <th><i class="bi bi-collection me-1"></i>Grup Adı</th>
                    <th><i class="bi bi-people me-1"></i>Kullanıcı Sayısı</th>
                    <th><i class="bi bi-calendar me-1"></i>Oluşturulma</th>
                    <th><i class="bi bi-person-check me-1"></i>Kullanıcılar</th>
                    <th><i class="bi bi-gear me-1"></i>İşlemler</th>
                  </tr>
                </thead>
                <tbody>
                  {% for group in groups %}
                    <tr class="group-row">
                      <td><strong>{{ group.name }}</strong></td>
                      <td><span class="badge bg-primary">{{ group.customuser_set.count }}</span></td>
                      <td><small class="text-muted">{{ group.id|date:"d.m.Y" }}</small></td>
                      <td>
                        {% for user in group.customuser_set.all|slice:":5" %}
                          <span class="badge bg-secondary me-1" title="{{ user.username }}">{{ user.username|slice:":2"|upper }}</span>
                        {% endfor %}
                        {% if group.customuser_set.count > 5 %}
                          <span class="text-muted small">+{{ group.customuser_set.count|add:"-5" }} daha</span>
                        {% endif %}
                      </td>
                      <td>
                        <div class="btn-group" role="group">
                          <button class="btn btn-sm btn-outline-info" onclick="showGroupUsers('{{ group.name }}', '{{ group.customuser_set.count }}')" title="Kullanıcıları Görüntüle"><i class="bi bi-eye"></i></button>
                          <button class="btn btn-sm btn-outline-danger" onclick="deleteGroup('{{ group.id }}', '{{ group.name }}')" title="Grubu Sil"><i class="bi bi-trash"></i></button>
                        </div>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="text-center py-5">
              <i class="bi bi-collection display-1 text-muted"></i>
              <h5 class="mt-3 text-muted">Henüz grup bulunmamaktadır.</h5>
              <p class="text-muted">Yeni bir grup oluşturmak için yukarıdaki butonu kullanabilirsiniz.</p>
              <a href="/accounts/admin/groups/create/" class="btn btn-primary"><i class="bi bi-plus-circle me-2"></i>İlk Grubu Oluşturun</a>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- JS & Styles -->
<style>
.avatar-circle {width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.2rem;}
.table th{font-weight:600;color:var(--text-color);border-bottom:2px solid var(--border-color);}
.group-row:hover{background-color:var(--surface-color);}
.user-avatars .badge{font-size:.7rem;}
#searchInput{border:1px solid var(--border-color);background-color:var(--secondary-bg);color:var(--text-color);}
#searchInput:focus{border-color:var(--primary-color);box-shadow:0 0 0 .2rem rgba(52,152,219,.25);}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const groupRows = document.querySelectorAll('.group-row');
    searchInput.addEventListener('input', function() {
        const term = this.value.toLowerCase();
        groupRows.forEach(r => r.style.display = r.querySelector('strong').textContent.toLowerCase().includes(term)?'':'none');
    });
});

function showGroupUsers(groupName, userCount){
    const modal = new bootstrap.Modal(document.getElementById('groupUsersModal'));
    document.getElementById('groupUsersModalLabel').innerHTML=`<i class="bi bi-people me-2"></i>${groupName} Grubu (${userCount} kullanıcı)`;
    document.getElementById('groupUsersContent').innerHTML='<div class="text-center"><div class="spinner-border" role="status"></div><p>Kullanıcılar yükleniyor...</p></div>';
    modal.show();
    setTimeout(()=>{document.getElementById('groupUsersContent').innerHTML='<p class="text-muted">Kullanıcı listesi buraya gelecek...</p>';},1000);
}

function deleteGroup(groupId, groupName){
    if(!confirm(`"${groupName}" grubunu silmek istediğinizden emin misiniz?\nBu işlem geri alınamaz!`)) return;
    const btn=document.querySelector(`button[onclick="deleteGroup('${groupId}','${groupName}')"]`),orig=btn.innerHTML; btn.innerHTML='<i class="bi bi-hourglass-split"></i>'; btn.disabled=true;
    const csrf=document.querySelector('[name=csrfmiddlewaretoken]')?.value||getCookie('csrftoken');
    fetch(`/accounts/admin/groups/${groupId}/delete/`,{method:'DELETE',headers:{'Content-Type':'application/json','X-CSRFToken':csrf}})
    .then(r=>r.json()).then(d=>{
        if(d.success){
            showAlert('success',d.message); const row=btn.closest('tr'); row.style.transition='all .3s ease'; row.style.opacity='0'; row.style.transform='translateX(-100%)';
            setTimeout(()=>{row.remove(); updateGroupCount(); checkEmptyState();},300);
        }else{showAlert('danger',d.error||'Grup silinirken hata oluştu'); btn.innerHTML=orig; btn.disabled=false;}
    }).catch(e=>{console.error(e); showAlert('danger','Grup silinirken hata oluştu'); btn.innerHTML=orig; btn.disabled=false;});
}

function showAlert(type,message){const a=document.createElement('div');a.className=`alert alert-${type} alert-dismissible fade show`;a.innerHTML=`<i class="bi bi-${type==='success'?'check-circle':'exclamation-triangle'} me-2"></i>${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;document.querySelector('.container-fluid').insertBefore(a,document.querySelector('.container-fluid').firstChild);setTimeout(()=>{if(a.parentNode)a.remove();},5000);}
function updateGroupCount(){const r=document.querySelectorAll('.group-row'); const c=document.querySelector('.card-body h4.text-primary'); if(c)c.textContent=r.length;}
function checkEmptyState(){if(document.querySelectorAll('.group-row').length===0){document.querySelector('.table-responsive').innerHTML=`<div class="text-center py-5"><i class="bi bi-collection display-1 text-muted"></i><h5 class="mt-3 text-muted">Henüz grup bulunmamaktadır.</h5><p class="text-muted">Yeni bir grup oluşturmak için yukarıdaki butonu kullanabilirsiniz.</p><a href="/accounts/admin/groups/create/" class="btn btn-primary"><i class="bi bi-plus-circle me-2"></i>İlk Grubu Oluşturun</a></div>`;}}
function getCookie(n){let c=null;if(document.cookie&&document.cookie!==''){document.cookie.split(';').forEach(k=>{const ck=k.trim();if(ck.substring(0,n.length+1)===(n+'='))c=decodeURIComponent(ck.substring(n.length+1));});} return c;}
</script>

<!-- Group Users Modal -->
<div class="modal fade" id="groupUsersModal" tabindex="-1" aria-labelledby="groupUsersModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="groupUsersModalLabel"><i class="bi bi-people me-2"></i>Grup Kullanıcıları</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="groupUsersContent"></div>
    </div>
  </div>
</div>
{% endblock %}