{% extends "tickets/base.html" %}

{% block title %}Yardım Masası – Kayıt{% endblock %}
{% block page_title %}Kayıt{% endblock %}

{% block breadcrumb %}
<!-- Signup sayfasında breadcrumb gösterme -->
{% endblock %}

{% block content %}
<div class="d-flex justify-content-center align-items-center" style="min-height: calc(100vh - 200px);">
  <div class="w-100" style="max-width: 400px;">

      <h2 class="text-center mb-4" style="color: var(--primary-color);">Kayıt Ol</h2>

      <!-- Signup Form -->
      <form id="signupForm" novalidate>
          {% csrf_token %}

          <!-- Hata Mesajları -->
          <div id="errorMessages" class="alert alert-danger d-none" role="alert"></div>
          
          <!-- Başarı Mesajları -->
          <div id="successMessages" class="alert alert-success d-none" role="alert"></div>

          <!-- Kullanıcı Adı -->
          <div class="form-floating mb-3">
              <input type="text" 
                     id="username" 
                     name="username" 
                     class="form-control" 
                     placeholder="Kullanıcı Adı" 
                     minlength="3"
                     maxlength="150"
                     pattern="[a-zA-Z0-9_-]+"
                     title="En az 3 karakter, sadece harf, rakam, alt çizgi (_) ve tire (-) kullanılabilir"
                     required>
              <label for="username">Kullanıcı Adı <small class="text-muted">(En az 3 karakter)</small></label>
              <div class="invalid-feedback">
                  Kullanıcı adı en az 3 karakter olmalı ve sadece harf, rakam, _ ve - içerebilir.
              </div>
          </div>

          <!-- E-posta -->
          <div class="form-floating mb-3">
              <input type="email" 
                     id="email" 
                     name="email" 
                     class="form-control" 
                     placeholder="E-posta" 
                     required>
              <label for="email">E-posta</label>
          </div>

          <!-- Parola -->
          <div class="form-floating mb-3">
              <input type="password" 
                     id="password1" 
                     name="password1" 
                     class="form-control" 
                     placeholder="Parola" 
                     required>
              <label for="password1">Parola</label>
          </div>

          <!-- Parola Tekrar -->
          <div class="form-floating mb-3">
              <input type="password" 
                     id="password2" 
                     name="password2" 
                     class="form-control" 
                     placeholder="Parola Tekrar" 
                     required>
              <label for="password2">Parola Tekrar</label>
          </div>

          <div class="d-grid mt-3">
              <button type="submit" id="signupBtn" class="btn btn-primary btn-lg">
                  <span class="spinner-border spinner-border-sm d-none me-2" role="status"></span>
                  <span class="btn-text">Kayıt Ol</span>
              </button>
          </div>
      </form>

      <div class="mt-3 text-center">
          <a href="{% url 'login' %}" class="text-decoration-none" style="color: var(--accent-color);">Zaten hesabım var? Giriş Yap</a>
      </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var signupForm = document.getElementById('signupForm');
    var signupBtn = document.getElementById('signupBtn');
    var spinner = signupBtn.querySelector('.spinner-border');
    var btnText = signupBtn.querySelector('.btn-text');
    var errorDiv = document.getElementById('errorMessages');
    var successDiv = document.getElementById('successMessages');

    // Sayfa yüklendiğinde eski authentication verilerini temizle

    
    // LocalStorage temizle
    localStorage.removeItem('authToken');
    localStorage.removeItem('userData');
    sessionStorage.clear();
    
    // Mevcut session cookie'leri temizle (güvenlik için)
    document.cookie.split(";").forEach(function(c) { 
        document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
    });
    


    // Username validation fonksiyonu
    function validateUsernameInput(username) {
        if (username.length < 3) return false;
        if (username.length > 150) return false;
        
        const usernamePattern = /^[a-zA-Z0-9_-]+$/;
        return usernamePattern.test(username);
    }

    // Real-time username validation
    const usernameInput = document.getElementById('username');
    const usernameFeedback = usernameInput.nextElementSibling;
    
    usernameInput.addEventListener('input', function() {
        let value = this.value;
        
        // Sadece geçerli karakterlere izin ver
        let cleanValue = value.replace(/[^a-zA-Z0-9_-]/g, '');
        
        if (value !== cleanValue) {
            this.value = cleanValue;
            console.log('Invalid characters removed from username');
        }
        
        const username = this.value.trim();
        const isValid = validateUsernameInput(username);
        
        if (username.length === 0) {
            // Boş ise herhangi bir feedback gösterme
            this.classList.remove('is-valid', 'is-invalid');
            usernameFeedback.style.display = 'none';
        } else if (isValid) {
            this.classList.remove('is-invalid');
            this.classList.add('is-valid');
            usernameFeedback.style.display = 'none';
        } else {
            this.classList.remove('is-valid');
            this.classList.add('is-invalid');
            usernameFeedback.style.display = 'block';
        }
    });

    signupForm.addEventListener('submit', function(e) {
        e.preventDefault();
        

        
        // Loading state
        signupBtn.disabled = true;
        spinner.classList.remove('d-none');
        btnText.textContent = 'Kayıt ediliyor...';
        
        // Form verilerini topla
        var username = document.getElementById('username').value.trim();
        var email = document.getElementById('email').value.trim();
        var password1 = document.getElementById('password1').value;
        var password2 = document.getElementById('password2').value;
        

        
        // Client-side validasyon
        if (!username || !email || !password1 || !password2) {
            showMessage(errorDiv, 'Lütfen tüm alanları doldurun.');
            resetLoadingState();
            return;
        }
        
        // Username validation
        if (username.length < 3) {
            showMessage(errorDiv, 'Kullanıcı adı en az 3 karakter olmalıdır.');
            resetLoadingState();
            return;
        }
        
        if (username.length > 150) {
            showMessage(errorDiv, 'Kullanıcı adı en fazla 150 karakter olabilir.');
            resetLoadingState();
            return;
        }
        
        // Username character validation
        var usernamePattern = /^[a-zA-Z0-9_-]+$/;
        if (!usernamePattern.test(username)) {
            showMessage(errorDiv, 'Kullanıcı adı sadece harf, rakam, alt çizgi (_) ve tire (-) içerebilir.');
            resetLoadingState();
            return;
        }
        
        if (password1 !== password2) {
            showMessage(errorDiv, 'Parolalar eşleşmiyor.');
            resetLoadingState();
            return;
        }
        
        if (password1.length < 8) {
            showMessage(errorDiv, 'Parola en az 8 karakter olmalıdır.');
            resetLoadingState();
            return;
        }
        
        // API çağrısı
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/accounts/api/signup/', true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {


                
                try {
                    var data = JSON.parse(xhr.responseText);

                    
                    if (xhr.status === 200 || xhr.status === 201) {
                        // Başarılı kayıt

                        
                        showMessage(successDiv, data.message || 'Hesap başarıyla oluşturuldu! Yönlendiriliyorsunuz...');
                        
                        // Yeni token'ları localStorage'a kaydet
                        if (data.token) {

                            localStorage.setItem('authToken', data.token);
                        }
                        if (data.user) {

                            localStorage.setItem('userData', JSON.stringify(data.user));
                        }
                        
                        // Güvenli çıkış önerisi butonu ekle
                        const safeLogoutBtn = document.createElement('button');
                        safeLogoutBtn.className = 'btn btn-outline-warning btn-sm mt-2 me-2';
                        safeLogoutBtn.innerHTML = '<i class="bi bi-shield-exclamation me-1"></i>Güvenli Çıkış Yap';
                        safeLogoutBtn.onclick = function() {
                            if (confirm('Admin panel sorununu önlemek için güvenli çıkış yapmak istiyor musunuz?')) {
                                // Base template'deki safeLogout fonksiyonunu çağır
                                if (typeof safeLogout === 'function') {
                                    safeLogout();
                                } else {
                                    // Fallback: Manuel güvenli çıkış
                                    localStorage.clear();
                                    sessionStorage.clear();
                                    document.cookie.split(";").forEach(function(c) { 
                                        document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
                                    });
                                    window.location.href = '/accounts/login/';
                                }
                            }
                        };
                        
                        successDiv.appendChild(safeLogoutBtn);
                        
                        // Direkt customer panel'e yönlendirme (home_view bypass)
                        setTimeout(function() {

                            window.location.href = '/accounts/customer-panel/';
                        }, 3000); // 3 saniye bekle
                        
                    } else {
                        // Hata durumu

                        showMessage(errorDiv, data.error || 'Kayıt olurken bir hata oluştu.');
                        resetLoadingState();
                    }
                    
                } catch (e) {


                    showMessage(errorDiv, 'Sunucu yanıtı işlenirken hata oluştu.');
                    resetLoadingState();
                }
            }
        };
        
        xhr.onerror = function() {

            showMessage(errorDiv, 'Ağ hatası. İnternet bağlantınızı kontrol edin.');
            resetLoadingState();
        };
        
        // Veri gönder
        var requestData = {
            username: username,
            email: email,
            password1: password1,
            password2: password2
        };
        

        xhr.send(JSON.stringify(requestData));
    });
    
    function resetLoadingState() {
        signupBtn.disabled = false;
        spinner.classList.add('d-none');
        btnText.textContent = 'Kayıt Ol';
    }
    
    function showMessage(element, message) {
        element.textContent = message;
        element.classList.remove('d-none');
        
        // Diğer mesaj kutusunu gizle
        if (element === errorDiv) {
            successDiv.classList.add('d-none');
        } else {
            errorDiv.classList.add('d-none');
        }
        
        // Otomatik gizleme (sadece hata mesajları için)
        if (element === errorDiv) {
            setTimeout(function() {
                element.classList.add('d-none');
            }, 5000);
        }
    }
});
</script>

<style>
.btn-primary {
  background: linear-gradient(135deg, var(--accent-color), #6366f1);
  border: none;
  border-radius: 8px;
  font-weight: 600;
  transition: all 0.3s ease;
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(var(--accent-color-rgb), 0.4);
}

.btn-primary:disabled {
  transform: none;
  opacity: 0.7;
}

.form-control:focus {
  border-color: var(--accent-color);
  box-shadow: 0 0 0 0.2rem rgba(var(--accent-color-rgb), 0.25);
}

/* Dark mode support */
@media (prefers-color-scheme: dark) {
  .form-control {
    background-color: #374151;
    border-color: #4b5563;
    color: #f9fafb;
  }
  
  .form-control:focus {
    background-color: #374151;
    color: #f9fafb;
  }
  
  .form-control::placeholder {
    color: #9ca3af;
  }
  
  .form-label {
    color: #f3f4f6;
  }
  
  .alert-danger {
    background-color: #7f1d1d;
    border-color: #ef4444;
    color: #fecaca;
  }
  
  .alert-success {
    background-color: #065f46;
    border-color: #10b981;
    color: #d1fae5;
  }
}
</style>
{% endblock %}
