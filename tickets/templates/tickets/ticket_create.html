{% extends "tickets/base.html" %}
{% load static %}

{% block title %}Yeni Talep{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'tickets/css/ticket_create.css' %}">
{% endblock %}

{% block page_title %}Yeni Talep Oluştur{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item">
  <a href="{% url 'ticket_list' %}" style="color: var(--accent-color);">
    <i class="bi bi-ticket-perforated me-1"></i>Talepler
  </a>
</li>
<li class="breadcrumb-item active" aria-current="page">Yeni Talep</li>
{% endblock %}

{% block content %}
<div class="container-fluid ticket-create-form">
  <div class="row justify-content-center">
    <div class="col-12 col-lg-8 col-xl-6">
      <!-- Header Section -->
      <div class="card border-0 shadow-sm mb-4 ticket-card">
        <div class="card-header ticket-header-gradient text-white border-0">
          <div class="d-flex align-items-center">
            <div class="rounded-circle bg-white bg-opacity-20 p-2 me-3">
              <i class="bi bi-plus-circle-fill text-white"></i>
            </div>
            <div>
              <h4 class="mb-0 fw-bold">Yeni Talep Oluştur</h4>
              <small class="opacity-75">Detayları doldurun ve talebinizi gönderin</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Form Section -->
      <div class="card border-0 shadow-sm ticket-card">
        <div class="card-body p-4">
          <form method="post" novalidate class="needs-validation">
            {% csrf_token %}

            <!-- Title Field -->
            <div class="mb-4">
              <label for="{{ form.title.id_for_label }}" class="form-label fw-semibold text-dark">
                <i class="bi bi-pencil-square me-2 text-primary"></i>{{ form.title.label }}
                <span class="text-danger">*</span>
              </label>
              <div class="input-group">
                <span class="input-group-text bg-light border-end-0">
                  <i class="bi bi-card-heading text-muted"></i>
                </span>
                <input type="text" 
                       class="form-control border-start-0 form-control-lg{% if form.title.errors %} is-invalid{% endif %}" 
                       id="{{ form.title.id_for_label }}" 
                       name="{{ form.title.name }}" 
                       value="{% if form.title.value %}{{ form.title.value }}{% endif %}"
                       placeholder="Talebinizin kısa ve açık bir başlığını yazın..."
                       required>
                {% if form.title.errors %}
                  <div class="invalid-feedback">
                    {{ form.title.errors|striptags }}
                  </div>
                {% endif %}
              </div>
            </div>

            <!-- Description Field -->
            <div class="mb-4">
              <label for="{{ form.description.id_for_label }}" class="form-label fw-semibold text-dark">
                <i class="bi bi-text-paragraph me-2 text-primary"></i>{{ form.description.label }}
                <span class="text-danger">*</span>
              </label>
              <div class="position-relative">
                <textarea class="form-control{% if form.description.errors %} is-invalid{% endif %}" 
                          id="{{ form.description.id_for_label }}" 
                          name="{{ form.description.name }}" 
                          rows="5" 
                          placeholder="Talebinizi detaylı bir şekilde açıklayın. Ne tür bir sorun yaşıyorsunuz veya ne tür bir hizmete ihtiyacınız var?"
                          required>{% if form.description.value %}{{ form.description.value }}{% endif %}</textarea>
                <small class="form-text text-muted">
                  <i class="bi bi-info-circle me-1"></i>Mümkün olduğunca detaylı bilgi verin
                </small>
                {% if form.description.errors %}
                  <div class="invalid-feedback">
                    {{ form.description.errors|striptags }}
                  </div>
                {% endif %}
              </div>
            </div>

            <!-- Priority and Category Row -->
            <div class="row mb-4">
              <div class="col-md-6 mb-3 mb-md-0">
                <label for="{{ form.priority.id_for_label }}" class="form-label fw-semibold text-dark">
                  <i class="bi bi-exclamation-triangle me-2 text-warning"></i>{{ form.priority.label }}
                </label>
                <div class="input-group">
                  <span class="input-group-text bg-light border-end-0">
                    <i class="bi bi-flag text-muted"></i>
                  </span>
                  <select class="form-select border-start-0{% if form.priority.errors %} is-invalid{% endif %}" 
                          id="{{ form.priority.id_for_label }}" 
                          name="{{ form.priority.name }}">
                    {% for value, text in form.priority.field.choices %}
                      <option value="{{ value }}" {% if form.priority.value == value %}selected{% endif %}>{{ text }}</option>
                    {% endfor %}
                  </select>
                  {% if form.priority.errors %}
                    <div class="invalid-feedback">
                      {{ form.priority.errors|striptags }}
                    </div>
                  {% endif %}
                </div>
              </div>

              <div class="col-md-6">
                <label for="{{ form.category.id_for_label }}" class="form-label fw-semibold text-dark">
                  <i class="bi bi-tags me-2 text-info"></i>{{ form.category.label }}
                </label>
                <div class="input-group">
                  <span class="input-group-text bg-light border-end-0">
                    <i class="bi bi-collection text-muted"></i>
                  </span>
                  <select class="form-select border-start-0{% if form.category.errors %} is-invalid{% endif %}" 
                          id="{{ form.category.id_for_label }}" 
                          name="{{ form.category.name }}">
                    {% for value, text in form.category.field.choices %}
                      <option value="{{ value }}" {% if form.category.value == value %}selected{% endif %}>{{ text }}</option>
                    {% endfor %}
                  </select>
                  {% if form.category.errors %}
                    <div class="invalid-feedback">
                      {{ form.category.errors|striptags }}
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- SLA and Assigned To Row -->
            <div class="row mb-4">
              <div class="col-md-6 mb-3 mb-md-0">
                <label for="{{ form.sla.id_for_label }}" class="form-label fw-semibold text-dark">
                  <i class="bi bi-clock me-2 text-success"></i>{{ form.sla.label }}
                </label>
                <div class="input-group">
                  <span class="input-group-text bg-light border-end-0">
                    <i class="bi bi-hourglass-split text-muted"></i>
                  </span>
                  <select class="form-select border-start-0{% if form.sla.errors %} is-invalid{% endif %}" 
                          id="{{ form.sla.id_for_label }}" 
                          name="{{ form.sla.name }}">
                    {% for value, text in form.sla.field.choices %}
                      <option value="{{ value }}" {% if form.sla.value == value %}selected{% endif %}>{{ text }}</option>
                    {% endfor %}
                  </select>
                  {% if form.sla.errors %}
                    <div class="invalid-feedback">
                      {{ form.sla.errors|striptags }}
                    </div>
                  {% endif %}
                </div>
              </div>

              <div class="col-md-6">
                <label for="{{ form.assigned_to.id_for_label }}" class="form-label fw-semibold text-dark">
                  <i class="bi bi-person-check me-2 text-primary"></i>{{ form.assigned_to.label }}
                  <small class="text-muted">(Opsiyonel)</small>
                </label>
                <div class="input-group">
                  <span class="input-group-text bg-light border-end-0">
                    <i class="bi bi-person text-muted"></i>
                  </span>
                  <select class="form-select border-start-0{% if form.assigned_to.errors %} is-invalid{% endif %}" 
                          id="{{ form.assigned_to.id_for_label }}" 
                          name="{{ form.assigned_to.name }}">
                    <option value="">--- Otomatik Atama ---</option>
                    {% for value, text in form.assigned_to.field.choices %}
                      {% if value %}
                        <option value="{{ value }}" {% if form.assigned_to.value == value %}selected{% endif %}>{{ text }}</option>
                      {% endif %}
                    {% endfor %}
                  </select>
                  {% if form.assigned_to.errors %}
                    <div class="invalid-feedback">
                      {{ form.assigned_to.errors|striptags }}
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="d-flex gap-3 justify-content-between align-items-center pt-3 border-top">
              <a href="{% url 'ticket_list' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-2"></i>Geri Dön
              </a>
              
              <div class="d-flex gap-2">
                <button type="button" class="btn btn-outline-primary" onclick="resetForm()">
                  <i class="bi bi-arrow-clockwise me-2"></i>Temizle
                </button>
                <button type="submit" class="btn btn-primary btn-lg px-4">
                  <i class="bi bi-send me-2"></i>Talep Gönder
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>

      <!-- Help Section -->
      <div class="card border-0 help-section mt-4">
        <div class="card-body p-3">
          <div class="d-flex align-items-start">
            <div class="text-primary me-3 mt-1">
              <i class="bi bi-lightbulb-fill"></i>
            </div>
            <div>
              <h6 class="mb-2 text-dark">💡 İpuçları</h6>
              <ul class="small text-muted mb-0 ps-3">
                <li>Başlık kısa ve öz olmalı</li>
                <li>Açıklamada sorunu detaylıca anlatın</li>
                <li>Doğru kategori ve öncelik seçin</li>
                <li>Acil durumlar için telefon ile de ulaşabilirsiniz</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function resetForm() {
  if (confirm('Formu temizlemek istediğinizden emin misiniz?')) {
    document.querySelector('form').reset();
    // Remove validation classes
    document.querySelectorAll('.is-valid, .is-invalid').forEach(el => {
      el.classList.remove('is-valid', 'is-invalid');
    });
  }
}

// Enhanced form validation and UX
document.addEventListener('DOMContentLoaded', function() {
  const form = document.querySelector('.needs-validation');
  const submitBtn = form.querySelector('button[type="submit"]');
  const originalBtnText = submitBtn.innerHTML;
  
  // Form submission with loading state
  form.addEventListener('submit', function(event) {
    if (!form.checkValidity()) {
      event.preventDefault();
      event.stopPropagation();
      
      // Shake animation for invalid form
      form.classList.add('was-validated');
      form.style.animation = 'shake 0.5s ease-in-out';
      setTimeout(() => form.style.animation = '', 500);
      
      // Focus first invalid field
      const firstInvalid = form.querySelector('.is-invalid, :invalid');
      if (firstInvalid) {
        firstInvalid.focus();
        firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    } else {
      // Show loading state
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Gönderiliyor...';
      
      // Add success class to form
      setTimeout(() => {
        form.classList.add('form-success');
      }, 100);
    }
    
    form.classList.add('was-validated');
  });

  // Real-time validation feedback with enhanced UX
  const inputs = form.querySelectorAll('input, textarea, select');
  inputs.forEach(input => {
    // Input focus effects
    input.addEventListener('focus', function() {
      this.parentElement.classList.add('focused');
    });
    
    input.addEventListener('blur', function() {
      this.parentElement.classList.remove('focused');
      
      // Validation feedback
      if (this.checkValidity()) {
        this.classList.remove('is-invalid');
        this.classList.add('is-valid');
        
        // Add success icon animation
        setTimeout(() => {
          this.style.animation = 'successBounce 0.3s ease-out';
          setTimeout(() => this.style.animation = '', 300);
        }, 100);
      } else {
        this.classList.remove('is-valid');
        this.classList.add('is-invalid');
        
        // Shake animation for invalid field
        this.style.animation = 'shake 0.3s ease-in-out';
        setTimeout(() => this.style.animation = '', 300);
      }
    });
    
    // Character counter for text fields
    if (input.type === 'text' || input.tagName === 'TEXTAREA') {
      addCharacterCounter(input);
    }
  });
  
  // Priority selection enhancement
  const prioritySelect = document.querySelector('select[name="priority"]');
  if (prioritySelect) {
    prioritySelect.addEventListener('change', function() {
      updatePriorityIndicator(this);
    });
    updatePriorityIndicator(prioritySelect); // Initial update
  }
  
  // Auto-save to localStorage (draft functionality)
  const autoSaveFields = ['title', 'description'];
  autoSaveFields.forEach(fieldName => {
    const field = form.querySelector(`[name="${fieldName}"]`);
    if (field) {
      // Load saved draft
      const savedValue = localStorage.getItem(`ticket_draft_${fieldName}`);
      if (savedValue && !field.value) {
        field.value = savedValue;
        showDraftNotification();
      }
      
      // Save on input
      field.addEventListener('input', debounce(() => {
        localStorage.setItem(`ticket_draft_${fieldName}`, field.value);
      }, 1000));
    }
  });
  
  // Clear drafts on successful submission
  form.addEventListener('submit', function(e) {
    if (form.checkValidity()) {
      autoSaveFields.forEach(fieldName => {
        localStorage.removeItem(`ticket_draft_${fieldName}`);
      });
    }
  });
});

// Helper functions
function addCharacterCounter(input) {
  const maxLength = input.getAttribute('maxlength');
  if (!maxLength) return;
  
  const counter = document.createElement('small');
  counter.className = 'form-text text-muted text-end d-block mt-1';
  counter.innerHTML = `<span class="current">0</span>/<span class="max">${maxLength}</span>`;
  
  input.parentElement.appendChild(counter);
  
  input.addEventListener('input', function() {
    const current = this.value.length;
    const currentSpan = counter.querySelector('.current');
    currentSpan.textContent = current;
    
    // Color coding
    const percentage = current / maxLength;
    if (percentage > 0.9) {
      counter.style.color = '#dc3545';
    } else if (percentage > 0.8) {
      counter.style.color = '#fd7e14';
    } else {
      counter.style.color = '#6c757d';
    }
  });
}

function updatePriorityIndicator(select) {
  const value = select.value;
  const indicator = select.parentElement.querySelector('.priority-indicator');
  
  if (indicator) {
    indicator.remove();
  }
  
  if (value) {
    const newIndicator = document.createElement('span');
    newIndicator.className = `priority-indicator priority-${value}`;
    select.parentElement.insertBefore(newIndicator, select);
  }
}

function showDraftNotification() {
  const notification = document.createElement('div');
  notification.className = 'alert alert-info alert-dismissible fade show';
  notification.innerHTML = `
    <i class="bi bi-info-circle me-2"></i>
    Kaydedilmiş taslak bulundu ve yüklendi.
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  
  const form = document.querySelector('.needs-validation');
  form.parentElement.insertBefore(notification, form);
  
  setTimeout(() => notification.remove(), 5000);
}

function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// Add shake animation keyframes
const style = document.createElement('style');
style.textContent = `
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
    20%, 40%, 60%, 80% { transform: translateX(5px); }
  }
`;
document.head.appendChild(style);
</script>
{% endblock %}