{% extends "tickets/base.html" %}
{% load static %}
{% load humanize %}
{% load badges %}  {# badge template tag'ı - badge(text, color) #}

{% block title %}{{ ticket.title }} | Yardım Masası{% endblock %}

{% block page_title %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/"><i class="fas fa-home"></i> Ana Sayfa</a></li>
        <li class="breadcrumb-item">
          <a href="{% url 'ticket_list' %}">
            <i class="fas fa-ticket-alt me-1"></i>Talepler
          </a>
        </li>
        <li class="breadcrumb-item active">#{{ ticket.ticket_number|default:ticket.pk }}</li>
      </ol>
    </nav>
    <h1 class="page-title">
      <i class="fas fa-ticket-alt text-primary me-2"></i>{{ ticket.title }}
    </h1>
    <p class="page-subtitle">Talep detayları ve durum takibi</p>
  </div>
</div>
{% endblock %}

{% block content %}
<div class="row">
  <div class="col-lg-8">
    <!-- Bilet Detay Kartı -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Talep Detayları</h5>
      </div>
      <div class="card-body">
        <div class="row mb-3">
          <div class="col-sm-3"><strong>Oluşturan:</strong></div>
          <div class="col-sm-9">{{ ticket.user.username }}</div>
        </div>
        <div class="row mb-3">
          <div class="col-sm-3"><strong>Durum:</strong></div>
          <div class="col-sm-9">{% status_badge ticket.get_status_display ticket.status %}</div>
        </div>
        <div class="row mb-3">
          <div class="col-sm-3"><strong>Öncelik:</strong></div>
          <div class="col-sm-9">{% priority_badge ticket.get_priority_display ticket.priority %}</div>
        </div>
        <div class="row mb-3">
          <div class="col-sm-3"><strong>Kategori:</strong></div>
          <div class="col-sm-9">
            {% if ticket.category %}
              {% badge ticket.category 'primary' %}
            {% else %}
              <span class="text-muted">Kategori belirtilmemiş</span>
            {% endif %}
          </div>
        </div>
        <div class="row mb-3">
          <div class="col-sm-3"><strong>Atanan:</strong></div>
          <div class="col-sm-9">
            {% if ticket.assigned_to %}
              {% badge ticket.assigned_to.username 'secondary' %}
            {% else %}
              <span class="text-muted">Henüz atanmamış</span>
            {% endif %}
          </div>
        </div>
        <div class="row mb-3">
          <div class="col-sm-3"><strong>Oluşturulma:</strong></div>
          <div class="col-sm-9">{{ ticket.created_at|date:"d.m.Y H:i" }}</div>
        </div>
        <div class="row">
          <div class="col-sm-3"><strong>Açıklama:</strong></div>
          <div class="col-sm-9">
            <div class="border rounded p-3 bg-light">
              {{ ticket.description|linebreaksbr }}
            </div>
          </div>
        </div>
      </div>
    </div>

  <!-- Açıklama -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">Açıklama</h5>
      <p class="card-text">{{ ticket.description|linebreaksbr }}</p>
    </div>
  </div>

  <!-- Durum Güncelleme -->
  {% if user_role == 'admin' or user_role == 'support' %}
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">Durumu Güncelle</h5>
      <select id="statusSelect" class="form-select">
        {% for value, label in ticket.STATUS_CHOICES %}
          <option value="{{ value }}" {% if ticket.status == value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>
  </div>

  <!-- Atama Güncelleme -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">Atanan Kullanıcıyı Güncelle</h5>
      <select id="assignedToSelect" class="form-select">
        <option value="">Seçim yap...</option>
        {% for user_obj in assignable_users %}
          <option value="{{ user_obj.id }}" {% if ticket.assigned_to == user_obj %}selected{% endif %}>
            {{ user_obj.username }}
          </option>
        {% endfor %}
      </select>
    </div>
  </div>
  {% endif %}

  <!-- Yorumlar -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">
        <i class="bi bi-chat-left-text me-2"></i>
        Yorumlar
        <span class="badge bg-secondary ms-2">{{ comments|length }}</span>
      </h5>
    </div>
    <div class="card-body">
      {% for comment in comments %}
        <div class="comment mb-3 p-3 border rounded bg-light">
          <div class="d-flex align-items-start">
            <div class="me-3">
              <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                {% if comment.user.role == 'admin' %}
                  <i class="bi bi-shield-fill"></i>
                {% elif comment.user.role == 'support' %}
                  <i class="bi bi-headset"></i>
                {% else %}
                  <i class="bi bi-person-fill"></i>
                {% endif %}
              </div>
            </div>
            <div class="flex-grow-1">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                  <strong class="text-primary">{{ comment.user.username }}</strong>
                  {% if comment.user.role == 'admin' %}
                    <span class="badge bg-danger ms-1">Admin</span>
                  {% elif comment.user.role == 'support' %}
                    <span class="badge bg-success ms-1">Support</span>
                  {% endif %}
                </div>
                <small class="text-muted">{{ comment.created_at|naturaltime }}</small>
              </div>
              <p class="mb-0">{{ comment.message|linebreaksbr }}</p>
            </div>
          </div>
        </div>
      {% empty %}
        <div class="text-center py-4">
          <i class="bi bi-chat-left-text text-muted" style="font-size: 2rem;"></i>
          <p class="text-muted mt-2 mb-0">Henüz yorum yapılmamış.</p>
          <small class="text-muted">İlk yorumu siz yazabilirsiniz!</small>
        </div>
      {% endfor %}
    </div>
  </div>

  <!-- Yorum Formu -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">
        <i class="bi bi-plus-circle me-2"></i>
        Yeni Yorum Ekle
      </h5>
    </div>
    <div class="card-body">
      <form method="post" id="commentForm">
        {% csrf_token %}
        <div class="d-flex align-items-start">
          <div class="me-3">
            <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
              {% if user.role == 'admin' %}
                <i class="bi bi-shield-fill"></i>
              {% elif user.role == 'support' %}
                <i class="bi bi-headset"></i>
              {% else %}
                <i class="bi bi-person-fill"></i>
              {% endif %}
            </div>
          </div>
          <div class="flex-grow-1">
            <div class="mb-3">
              <textarea id="commentContent" name="comment" class="form-control" rows="3" placeholder="Yorumunuzu yazın..." required></textarea>
              <small id="characterCounter" class="text-muted float-end">0/1000 karakter</small>
            </div>
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-send me-2"></i>
              Yorum Gönder
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- JavaScript URL'lerini tanımla -->
<script>
  window.changeStatusURL = "{% url 'change_ticket_status' ticket.pk %}";
  window.updateAssignmentURL = "{% url 'update_ticket_assignment' ticket.pk %}";
</script>

<!-- JS dosyasını çağır -->
<script src="{% static 'tickets/js/ticket_detail.js' %}"></script>
{% endblock %}