{% extends "tickets/base.html" %}
{% load static %}

{% block title %}Talep Listesi - HelpDesk{% endblock %}

{% block page_title %}
{% csrf_token %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/"><i class="fas fa-home"></i> Ana Sayfa</a></li>
        <li class="breadcrumb-item active">Talepler</li>
      </ol>
    </nav>
    <!-- Rol bazlı başlık -->
    {% if user_role == 'admin' %}
      <h1 class="page-title"><i class="fas fa-shield-alt text-danger me-2"></i>Tüm Talepler <span class="badge bg-danger">Admin</span></h1>
      <p class="page-subtitle">Sistem genelindeki tüm talepleri yönetebilirsiniz.</p>
    {% elif user_role == 'support' %}
      <h1 class="page-title"><i class="fas fa-headset text-success me-2"></i>Tüm Talepler <span class="badge bg-success">Destek</span></h1>
      <p class="page-subtitle">Taleplerin durumlarını değiştirebilirsiniz.</p>
    {% else %}
      <h1 class="page-title"><i class="fas fa-users text-primary me-2"></i>Grup Talepleri <span class="badge bg-primary">Kullanıcı</span></h1>
      <p class="page-subtitle">Grubunuzdaki talepleri görüntüleyebilirsiniz.</p>
    {% endif %}
  </div>
  <div>
    <a href="/tickets/create/" class="btn btn-primary"><i class="fas fa-plus-circle me-2"></i>Yeni Talep</a>
  </div>
</div>
{% endblock %}

{% block content %}

<!-- CSRF token -->
<form style="display:none;">{% csrf_token %}</form>

<!-- Filtre alanı -->
<div class="card mb-4">
  <div class="card-body">
    <form method="get" class="row g-3 align-items-end">
      {% include "includes/filter_select.html" with label="Durum" icon="fa-flag" name="status" choices=status_choices current=current_status_filter %}
      {% include "includes/filter_select.html" with label="Öncelik" icon="fa-exclamation-triangle" name="priority" choices=priority_choices current=current_priority_filter %}
      <div class="col-md-6">
        <button type="submit" class="btn btn-outline-primary me-2"><i class="fas fa-filter me-1"></i>Filtrele</button>
        <a href="/tickets/" class="btn btn-outline-secondary"><i class="fas fa-redo me-1"></i>Temizle</a>
      </div>
    </form>
  </div>
</div>

<!-- Listeleme alanı -->
{% if tickets %}
  <div class="table-responsive mt-4">
    <table class="table table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th>#</th>
          <th>Başlık</th>
          <th>Kullanıcı</th>
          <th>Kategori</th>
          <th>Durum</th>
          <th>Öncelik</th>
          <th>Atanan</th>
          <th>Oluşturulma</th>
          {% if is_admin or is_support %}<th>İşlemler</th>{% endif %}
        </tr>
      </thead>
      <tbody>
        {% for ticket in tickets %}
          <tr>
            <td><a href="/tickets/{{ ticket.pk }}/" class="fw-bold text-primary">#{{ ticket.talep_numarasi|default:ticket.pk }}</a></td>
            <td>{{ ticket.title|truncatechars:50 }}</td>
            <td>{{ ticket.user.username }}</td>
            <td>{{ ticket.category.name|default:"-" }}</td>

            <!-- Durum etiketi: helper partial -->
            {% include "includes/status_badge.html" with value=ticket.status display=ticket.get_status_display %}

            <!-- Öncelik etiketi: helper partial -->
            {% include "includes/priority_badge.html" with value=ticket.priority display=ticket.get_priority_display %}

            <td>{{ ticket.assigned_to.username|default:"Atanmamış" }}</td>
            <td>{{ ticket.created_at|date:"d.m.Y H:i" }}</td>

            {% if is_admin or is_support %}
              <td>
                <div class="btn-group">
                  <button class="btn btn-outline-primary btn-sm status-change-btn"
                          data-ticket-id="{{ ticket.pk }}"
                          data-current-status="{{ ticket.status }}"
                          data-ticket-title="{{ ticket.title|truncatechars:30 }}">
                    <i class="fas fa-edit"></i>
                  </button>
                  <a href="/tickets/{{ ticket.pk }}/" class="btn btn-outline-secondary btn-sm"><i class="fas fa-eye"></i></a>
                </div>
              </td>
            {% endif %}
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% else %}
  <!-- Hiç kayıt yoksa -->
  <div class="text-center py-5">
    <i class="fas fa-inbox fa-4x text-muted mb-3"></i>
    <h5 class="text-muted">Henüz talep bulunmamaktadır</h5>
    <a href="/tickets/create/" class="btn btn-primary mt-2"><i class="fas fa-plus-circle me-2"></i>İlk Talebinizi Oluşturun</a>
  </div>
{% endif %}

<!-- Status Değiştirme Modal -->
<div class="modal fade" id="statusModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Durum Değiştir</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p class="mb-3">Ticket: <strong id="modalTicketTitle"></strong></p>
        <div class="mb-3">
          <label for="newStatus" class="form-label">Yeni Durum</label>
          <select class="form-select" id="newStatus">
            <option value="new">Yeni</option>
            <option value="seen">Görüldü</option>
            <option value="open">Açık</option>
            <option value="pending">Beklemeye Alındı</option>
            <option value="in_progress">İşlemde</option>
            <option value="resolved">Çözüldü</option>
            <option value="closed">Kapatıldı</option>
            <option value="wrong_section">Yanlış Bölüm</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
        <button type="button" class="btn btn-primary" id="updateStatusBtn">Durumu Güncelle</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentTicketId = null;
    const statusModal = new bootstrap.Modal(document.getElementById('statusModal'));
    
    // Status change button click handler
    document.querySelectorAll('.status-change-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            currentTicketId = this.dataset.ticketId;
            const currentStatus = this.dataset.currentStatus;
            const ticketTitle = this.dataset.ticketTitle;
            
            document.getElementById('modalTicketTitle').textContent = ticketTitle;
            document.getElementById('newStatus').value = currentStatus;
            
            statusModal.show();
        });
    });
    
    // Update status button handler
    document.getElementById('updateStatusBtn').addEventListener('click', function() {
        const newStatus = document.getElementById('newStatus').value;
        const btn = this;
        
        // Disable button and show loading
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Güncelleniyor...';
        
        fetch('/tickets/update-status/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                ticket_id: currentTicketId,
                new_status: newStatus
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message
                showAlert('success', data.message);
                
                // Update the status badge in the table
                updateStatusBadgeInTable(currentTicketId, newStatus, data.new_status_display);
                
                // Close modal
                statusModal.hide();
            } else {
                showAlert('danger', data.message);
            }
        })
        .catch(error => {
            showAlert('danger', 'Bir hata oluştu: ' + error.message);
        })
        .finally(() => {
            // Reset button
            btn.disabled = false;
            btn.innerHTML = 'Durumu Güncelle';
        });
    });
    
    function updateStatusBadgeInTable(ticketId, newStatus, newStatusDisplay) {
        // Find the ticket row and update the status badge
        const statusCell = document.querySelector(`tr [data-ticket-id="${ticketId}"]`).closest('tr').querySelector('td:nth-child(5)');
        if (statusCell) {
            // Get status color
            const statusColors = {
                'new': 'primary',
                'seen': 'info',
                'open': 'warning',
                'pending': 'secondary',
                'in_progress': 'info',
                'resolved': 'success',
                'closed': 'dark',
                'wrong_section': 'danger'
            };
            const color = statusColors[newStatus] || 'secondary';
            statusCell.innerHTML = `<span class="badge bg-${color} bg-opacity-10 text-${color} border border-${color} border-opacity-25 px-3 py-2">${newStatusDisplay}</span>`;
        }
    }
    
    function showAlert(type, message) {
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        alert.style.cssText = 'top: 20px; right: 20px; z-index: 1060; min-width: 300px;';
        alert.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alert);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            if (alert.parentNode) {
                alert.remove();
            }
        }, 5000);
    }
});
</script>
{% endblock %}