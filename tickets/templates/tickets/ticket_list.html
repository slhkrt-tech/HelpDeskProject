{% extends "tickets/base.html" %}
{% load static %}

{% block title %}Talep Listesi{% endblock %}
{% block page_title %}Talep Listesi{% endblock %}

<!-- Modern CSS için -->
{% block extra_css %}
<link rel="stylesheet" href="{% static 'tickets/css/ticket_list_modern.css' %}">
{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb" class="mb-4">
  <ol class="breadcrumb">
    <li class="breadcrumb-item">
      <a href="{% url 'home' %}" style="color: var(--accent-color);">
        <i class="bi bi-house-door me-1"></i>Ana Sayfa
      </a>
    </li>
    <li class="breadcrumb-item active" aria-current="page">Talepler</li>
  </ol>
</nav>
{% endblock %}

{% block content %}
<!-- CSRF Token için hidden form -->
<form style="display: none;">
  {% csrf_token %}
</form>
<div class="container-fluid">
  <!-- Filtreler ve Başlık -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h1 class="h3 mb-0">
            {% if user_role == 'admin' %}
              <i class="bi bi-shield-check text-danger me-2"></i>Tüm Talepler (Admin)
            {% elif user_role == 'support' %}
              <i class="bi bi-headset text-success me-2"></i>Tüm Talepler (Destek)
            {% else %}
              <i class="bi bi-person text-primary me-2"></i>Grup Talepleri
            {% endif %}
          </h1>
          <p class="text-muted mb-0">
            {% if user_role == 'admin' %}
              Sistem genelindeki tüm talepleri görüntüleyebilir ve yönetebilirsiniz.
            {% elif user_role == 'support' %}
              Sistem genelindeki tüm talepleri görüntüleyebilir ve durumlarını değiştirebilirsiniz.
            {% else %}
              Grup içindeki talepleri görüntüleyebilirsiniz.
            {% endif %}
          </p>
        </div>
        <div>
          <a href="{% url 'ticket_create' %}" class="btn btn-primary">
            <i class="bi bi-plus-circle me-2"></i>Yeni Talep
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Filtreler -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <form method="get" class="row g-3">
            <div class="col-md-3">
              <label for="status" class="form-label">Durum</label>
              <select name="status" id="status" class="form-select">
                <option value="">Tüm Durumlar</option>
                {% for status_value, status_display in status_choices %}
                  <option value="{{ status_value }}" {% if current_status_filter == status_value %}selected{% endif %}>
                    {{ status_display }}
                  </option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-3">
              <label for="priority" class="form-label">Öncelik</label>
              <select name="priority" id="priority" class="form-select">
                <option value="">Tüm Öncelikler</option>
                {% for priority_value, priority_display in priority_choices %}
                  <option value="{{ priority_value }}" {% if current_priority_filter == priority_value %}selected{% endif %}>
                    {{ priority_display }}
                  </option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6 d-flex align-items-end">
              <button type="submit" class="btn btn-outline-primary me-2">
                <i class="bi bi-funnel me-1"></i>Filtrele
              </button>
              <a href="{% url 'ticket_list' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-clockwise me-1"></i>Temizle
              </a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Talep Listesi -->
  <div class="row">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          {% if tickets %}
            <!-- Modern Ticket Table -->
            <div class="table-responsive-modern">
              <table class="table modern-table mb-0">
                <thead>
                  <tr>
                    <th><i class="bi bi-hash me-1"></i>Numara</th>
                    <th><i class="bi bi-card-text me-1"></i>Başlık</th>
                    <th><i class="bi bi-person me-1"></i>Kullanıcı</th>
                    <th><i class="bi bi-folder me-1"></i>Kategori</th>
                    <th><i class="bi bi-circle me-1"></i>Durum</th>
                    <th><i class="bi bi-exclamation-circle me-1"></i>Öncelik</th>
                    <th><i class="bi bi-person-check me-1"></i>Atanan</th>
                    <th><i class="bi bi-calendar me-1"></i>Oluşturulma</th>
                    {% if is_admin or is_support %}
                      <th class="actions-column"><i class="bi bi-gear me-1"></i>İşlemler</th>
                    {% endif %}
                  </tr>
                </thead>
                <tbody>
                  {% for ticket in tickets %}
                    <tr>
                      <td>
                        <a href="{% url 'ticket_detail' ticket.pk %}" class="text-decoration-none fw-bold text-primary">
                          #{{ ticket.talep_numarasi }}
                        </a>
                      </td>
                      <td>
                        <a href="{% url 'ticket_detail' ticket.pk %}" class="text-decoration-none text-dark">
                          {{ ticket.title|truncatechars:50 }}
                        </a>
                      </td>
                      <td>
                        <div class="d-flex align-items-center">
                          <div class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px; font-size: 0.875rem;">
                            {{ ticket.user.username|first|upper }}
                          </div>
                          {{ ticket.user.username }}
                        </div>
                      </td>
                      <td>
                        {% if ticket.category %}
                          <span class="badge bg-info bg-opacity-10 text-info border border-info border-opacity-25 px-3 py-2">
                            <i class="bi bi-folder me-1"></i>{{ ticket.category.name }}
                          </span>
                        {% else %}
                          <span class="text-muted">-</span>
                        {% endif %}
                      </td>
                      <td>
                        <span class="status-badge status-{{ ticket.status }}" id="status-badge-{{ ticket.pk }}">
                          {{ ticket.get_status_display }}
                        </span>
                      </td>
                      <td>
                        <span class="badge 
                          {% if ticket.priority == 'low' %}bg-success bg-opacity-10 text-success border border-success border-opacity-25
                          {% elif ticket.priority == 'normal' %}bg-primary bg-opacity-10 text-primary border border-primary border-opacity-25
                          {% elif ticket.priority == 'high' %}bg-warning bg-opacity-10 text-warning border border-warning border-opacity-25
                          {% elif ticket.priority == 'urgent' %}bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25
                          {% endif %} px-3 py-2">
                          {% if ticket.priority == 'low' %}<i class="bi bi-arrow-down me-1"></i>
                          {% elif ticket.priority == 'normal' %}<i class="bi bi-dash me-1"></i>
                          {% elif ticket.priority == 'high' %}<i class="bi bi-arrow-up me-1"></i>
                          {% elif ticket.priority == 'urgent' %}<i class="bi bi-exclamation-triangle me-1"></i>
                          {% endif %}
                          {{ ticket.get_priority_display }}
                        </span>
                      </td>
                      <td>
                        {% if ticket.assigned_to %}
                          <div class="d-flex align-items-center">
                            <div class="avatar-sm bg-success text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px; font-size: 0.875rem;">
                              {{ ticket.assigned_to.username|first|upper }}
                            </div>
                            {{ ticket.assigned_to.username }}
                          </div>
                        {% else %}
                          <span class="text-muted">
                            <i class="bi bi-person-dash me-1"></i>Atanmamış
                          </span>
                        {% endif %}
                      </td>
                      <td>
                        <div class="d-flex flex-column">
                          <span class="fw-medium">{{ ticket.created_at|date:"d.m.Y" }}</span>
                          <small class="text-muted">{{ ticket.created_at|date:"H:i" }}</small>
                        </div>
                      </td>
                      {% if is_admin or is_support %}
                        <td class="actions-column">
                          <div class="status-action-container">
                            <button class="status-change-dropdown" type="button" data-ticket-id="{{ ticket.pk }}">
                              <i class="bi bi-arrow-repeat me-1"></i>Durum Değiştir
                              <i class="bi bi-chevron-down ms-1"></i>
                            </button>
                            <div class="status-dropdown-menu" style="display: none;">
                              {% for status_value, status_display in status_choices %}
                                {% if status_value != ticket.status %}
                                  <button class="status-dropdown-item" 
                                          data-ticket-id="{{ ticket.pk }}" 
                                          data-status="{{ status_value }}">
                                    {{ status_display }}
                                  </button>
                                {% endif %}
                              {% endfor %}
                            </div>
                          </div>
                        </td>
                      {% endif %}
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="text-center py-5">
              <i class="bi bi-inbox display-1 text-muted"></i>
              <h5 class="mt-3 text-muted">Henüz talep bulunmamaktadır.</h5>
              <p class="text-muted">Yeni bir talep oluşturmak için yukarıdaki butonu kullanabilirsiniz.</p>
              <a href="{% url 'ticket_create' %}" class="btn btn-primary">
                <i class="bi bi-plus-circle me-2"></i>İlk Talebinizi Oluşturun
              </a>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modern JavaScript için -->
{% block extra_js %}
<script src="{% static 'tickets/js/ticket_list_modern.js' %}"></script>
{% endblock %}

{% endblock %}