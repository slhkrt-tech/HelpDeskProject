{% extends "tickets/base.html" %}

{% block title %}Talep Listesi{% endblock %}
{% block page_title %}Talep Listesi{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb" class="mb-4">
  <ol class="breadcrumb">
    <li class="breadcrumb-item">
      <a href="{% url 'home' %}" style="color: var(--accent-color);">
        <i class="bi bi-house-door me-1"></i>Ana Sayfa
      </a>
    </li>
    <li class="breadcrumb-item active" aria-current="page">Talepler</li>
  </ol>
</nav>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- Filtreler ve Başlık -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h1 class="h3 mb-0">
            {% if user_role == 'admin' %}
              <i class="bi bi-shield-check text-danger me-2"></i>Tüm Talepler (Admin)
            {% elif user_role == 'support' %}
              <i class="bi bi-headset text-success me-2"></i>Tüm Talepler (Destek)
            {% else %}
              <i class="bi bi-person text-primary me-2"></i>Grup Talepleri
            {% endif %}
          </h1>
          <p class="text-muted mb-0">
            {% if user_role == 'admin' %}
              Sistem genelindeki tüm talepleri görüntüleyebilir ve yönetebilirsiniz.
            {% elif user_role == 'support' %}
              Sistem genelindeki tüm talepleri görüntüleyebilir ve durumlarını değiştirebilirsiniz.
            {% else %}
              Grup içindeki talepleri görüntüleyebilirsiniz.
            {% endif %}
          </p>
        </div>
        <div>
          <a href="{% url 'ticket_create' %}" class="btn btn-primary">
            <i class="bi bi-plus-circle me-2"></i>Yeni Talep
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Filtreler -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <form method="get" class="row g-3">
            <div class="col-md-3">
              <label for="status" class="form-label">Durum</label>
              <select name="status" id="status" class="form-select">
                <option value="">Tüm Durumlar</option>
                {% for status_value, status_display in status_choices %}
                  <option value="{{ status_value }}" {% if current_status_filter == status_value %}selected{% endif %}>
                    {{ status_display }}
                  </option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-3">
              <label for="priority" class="form-label">Öncelik</label>
              <select name="priority" id="priority" class="form-select">
                <option value="">Tüm Öncelikler</option>
                {% for priority_value, priority_display in priority_choices %}
                  <option value="{{ priority_value }}" {% if current_priority_filter == priority_value %}selected{% endif %}>
                    {{ priority_display }}
                  </option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6 d-flex align-items-end">
              <button type="submit" class="btn btn-outline-primary me-2">
                <i class="bi bi-funnel me-1"></i>Filtrele
              </button>
              <a href="{% url 'ticket_list' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-clockwise me-1"></i>Temizle
              </a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Talep Listesi -->
  <div class="row">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          {% if tickets %}
            <div class="table-responsive">
              <table class="table table-hover align-middle">
                <thead class="table-light">
                  <tr>
                    <th>#</th>
                    <th>Başlık</th>
                    <th>Oluşturan</th>
                    <th>Kategori</th>
                    <th>Durum</th>
                    <th>Öncelik</th>
                    <th>Atanan</th>
                    <th>Oluşturulma</th>
                    {% if is_admin or is_support %}
                      <th>İşlemler</th>
                    {% endif %}
                  </tr>
                </thead>
                <tbody>
                  {% for ticket in tickets %}
                    <tr>
                      <td>
                        <a href="{% url 'ticket_detail' ticket.pk %}" class="text-decoration-none">
                          <strong>#{{ ticket.talep_numarasi }}</strong>
                        </a>
                      </td>
                      <td>
                        <a href="{% url 'ticket_detail' ticket.pk %}" class="text-decoration-none">
                          {{ ticket.title|truncatechars:50 }}
                        </a>
                      </td>
                      <td>
                        <span class="d-flex align-items-center">
                          <i class="bi bi-person-circle me-2"></i>
                          {{ ticket.user.username }}
                        </span>
                      </td>
                      <td>
                        {% if ticket.category %}
                          <span class="badge bg-info">{{ ticket.category.name }}</span>
                        {% else %}
                          <span class="text-muted">-</span>
                        {% endif %}
                      </td>
                      <td>
                        <span class="badge 
                          {% if ticket.status == 'new' %}bg-primary
                          {% elif ticket.status == 'seen' %}bg-info
                          {% elif ticket.status == 'open' %}bg-warning
                          {% elif ticket.status == 'pending' %}bg-secondary
                          {% elif ticket.status == 'in_progress' %}bg-info
                          {% elif ticket.status == 'resolved' %}bg-success
                          {% elif ticket.status == 'closed' %}bg-dark
                          {% else %}bg-light text-dark
                          {% endif %}" id="status-badge-{{ ticket.pk }}">
                          {{ ticket.get_status_display }}
                        </span>
                      </td>
                      <td>
                        <span class="badge 
                          {% if ticket.priority == 'low' %}bg-success
                          {% elif ticket.priority == 'normal' %}bg-primary
                          {% elif ticket.priority == 'high' %}bg-warning
                          {% elif ticket.priority == 'urgent' %}bg-danger
                          {% endif %}">
                          {{ ticket.get_priority_display }}
                        </span>
                      </td>
                      <td>
                        {% if ticket.assigned_to %}
                          <span class="d-flex align-items-center">
                            <i class="bi bi-person-check me-2"></i>
                            {{ ticket.assigned_to.username }}
                          </span>
                        {% else %}
                          <span class="text-muted">Atanmamış</span>
                        {% endif %}
                      </td>
                      <td>
                        <small class="text-muted">
                          {{ ticket.created_at|date:"d.m.Y H:i" }}
                        </small>
                      </td>
                      {% if is_admin or is_support %}
                        <td>
                          <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" 
                                    data-bs-toggle="dropdown" aria-expanded="false">
                              Durum Değiştir
                            </button>
                            <ul class="dropdown-menu">
                              {% for status_value, status_display in status_choices %}
                                {% if status_value != ticket.status %}
                                  <li>
                                    <button class="dropdown-item change-status-btn" 
                                            data-ticket-id="{{ ticket.pk }}" 
                                            data-new-status="{{ status_value }}">
                                      {{ status_display }}
                                    </button>
                                  </li>
                                {% endif %}
                              {% endfor %}
                            </ul>
                          </div>
                        </td>
                      {% endif %}
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="text-center py-5">
              <i class="bi bi-inbox display-1 text-muted"></i>
              <h5 class="mt-3 text-muted">Henüz talep bulunmamaktadır.</h5>
              <p class="text-muted">Yeni bir talep oluşturmak için yukarıdaki butonu kullanabilirsiniz.</p>
              <a href="{% url 'ticket_create' %}" class="btn btn-primary">
                <i class="bi bi-plus-circle me-2"></i>İlk Talebinizi Oluşturun
              </a>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body text-center py-4">
        <div class="spinner-border text-primary mb-3" role="status">
          <span class="visually-hidden">Yükleniyor...</span>
        </div>
        <p class="mb-0">Durum güncelleniyor...</p>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Status değiştirme işlemi
    const changeStatusBtns = document.querySelectorAll('.change-status-btn');
    const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
    
    changeStatusBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const ticketId = this.getAttribute('data-ticket-id');
            const newStatus = this.getAttribute('data-new-status');
            
            // Loading modal göster
            loadingModal.show();
            
            // CSRF token al
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                             getCookie('csrftoken');
            
            // AJAX isteği
            fetch(`/tickets/${ticketId}/change-status/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken,
                },
                body: `status=${newStatus}`
            })
            .then(response => response.json())
            .then(data => {
                loadingModal.hide();
                
                if (data.success) {
                    // Badge'i güncelle
                    const badge = document.getElementById(`status-badge-${ticketId}`);
                    if (badge) {
                        badge.textContent = data.new_status_display;
                        
                        // Badge rengini güncelle
                        badge.className = 'badge ';
                        if (newStatus === 'new') badge.className += 'bg-primary';
                        else if (newStatus === 'seen') badge.className += 'bg-info';
                        else if (newStatus === 'open') badge.className += 'bg-warning';
                        else if (newStatus === 'pending') badge.className += 'bg-secondary';
                        else if (newStatus === 'in_progress') badge.className += 'bg-info';
                        else if (newStatus === 'resolved') badge.className += 'bg-success';
                        else if (newStatus === 'closed') badge.className += 'bg-dark';
                        else badge.className += 'bg-light text-dark';
                    }
                    
                    // Başarı mesajı
                    showToast('Durum başarıyla güncellendi!', 'success');
                } else {
                    showToast('Hata: ' + data.error, 'error');
                }
            })
            .catch(error => {
                loadingModal.hide();
                console.error('Error:', error);
                showToast('Bir hata oluştu!', 'error');
            });
        });
    });
    
    // Toast mesaj gösterme
    function showToast(message, type) {
        // Basit toast implementasyonu
        const toast = document.createElement('div');
        toast.className = `alert alert-${type === 'success' ? 'success' : 'danger'} position-fixed top-0 end-0 m-3`;
        toast.style.zIndex = '9999';
        toast.textContent = message;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }
    
    // CSRF cookie yardımcı fonksiyonu
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>

{% endblock %}